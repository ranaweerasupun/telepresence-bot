<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Robot Peer (demo)</title>
  </head>
  <body>
    <h2>Robot Peer</h2>
    <video id="local" autoplay muted playsinline width="320"></video>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      // 1️⃣  Ask user for Robot ID once page loads
      const robotId = prompt("Enter Robot ID to host:", "TESTBOT")?.trim();
      if (!robotId) location.reload();

      // 2️⃣  Connect to signalling
      const sock = io({ transports: ["websocket"] }); // guarantee WS (Glitch likes that)

      // 3️⃣  WebRTC setup
      const pc = new RTCPeerConnection({
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      });
      pc.onicecandidate = (e) =>
        e.candidate && sock.emit("candidate", e.candidate);

      // 4️⃣  Get cam+mic
      navigator.mediaDevices
        .getUserMedia({ video: true, audio: true })
        .then((stream) => {
          document.getElementById("local").srcObject = stream;
          stream.getTracks().forEach((t) => pc.addTrack(t, stream));
        });

      // 5️⃣  Signalling handlers
      sock.on("offer", async (off) => {
        await pc.setRemoteDescription(off);
        await pc.setLocalDescription(await pc.createAnswer());
        sock.emit("answer", pc.localDescription);
      });
      sock.on("candidate", (c) => pc.addIceCandidate(c));

      // 6️⃣  Join room
      sock.emit("join", { robotId, role: "robot" });
      console.log("Robot ready in room", robotId);
    </script>
  </body>
</html>
